name: Notify Discord

on:
  push:
    branches:
      - main
  workflow_run:
    workflows: ["Build", "Test"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    environment: DEVELOPMENT
    steps:
      - name: Send message to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Extract commit info from GitHub context
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          DESCRIPTION="${{ github.event.head_commit.message }}"
          SHORT_SHA="${GITHUB_SHA::7}"

          # Optional: escape double quotes in the message
          SAFE_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed 's/"/\\"/g')

          # Format Discord message
          PAYLOAD=$(jq -n \
            --arg content ":rocket: **New commit pushed by $AUTHOR**" \
            --arg msg "**Message:** $SAFE_MESSAGE\n**Commit:** [$SHORT_SHA]($COMMIT_URL)" \
            '{content: $content, embeds: [{description: $msg}]}'
          )

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"
