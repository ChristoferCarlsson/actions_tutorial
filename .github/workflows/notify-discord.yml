name: Notify Discord

on:
  push:
    branches:
      - main
  workflow_run:
    workflows: ["Build", "Test"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    environment: DEVELOPMENT
    steps:
      - name: Send message to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          SHORT_SHA="${GITHUB_SHA::7}"

          # Clean up message (replace quotes, escape backslashes)
          SAFE_MESSAGE=$(echo "$COMMIT_MESSAGE" | jq -Rs . | jq -r .)

          # Build a nicer embed payload
          PAYLOAD=$(jq -n \
            --arg title ":rocket: New commit pushed by $AUTHOR" \
            --arg description "$SAFE_MESSAGE" \
            --arg url "$COMMIT_URL" \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            --arg sha "$SHORT_SHA" \
            '{embeds: [{
              title: $title,
              description: $description,
              color: 5814783,
              fields: [
                {name: "Repository", value: $repo, inline: true},
                {name: "Branch", value: $branch, inline: true},
                {name: "Commit", value: ("[" + $sha + "](" + $url + ")"), inline: false}
              ]
            }]}'
          )

          echo "$PAYLOAD"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"
