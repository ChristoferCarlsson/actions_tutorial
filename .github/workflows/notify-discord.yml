name: Notify Discord

on:
  push:
    branches:
      - main
  workflow_run:
    workflows: ["Build", "Test"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    environment: DEVELOPMENT

    steps:
      - name: Send commit info to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          COMMIT_AUTHOR: ${{ github.actor }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Split message: first line = subject, rest = description
          COMMIT_NAME=$(echo "$COMMIT_MESSAGE" | head -n 1)
          COMMIT_DESC=$(echo "$COMMIT_MESSAGE" | tail -n +2 | sed '/^$/d')
          if [ -z "$COMMIT_DESC" ]; then
            COMMIT_DESC="No description provided."
          fi

          # Build Discord message safely
          MESSAGE=$(cat <<EOF
New commit pushed by ${COMMIT_AUTHOR}

Commit-Name: ${COMMIT_NAME}
Description: ${COMMIT_DESC}

Commit: [${COMMIT_SHA}](${COMMIT_URL})
EOF
)

          # Escape JSON properly
          ESCAPED_MESSAGE=$(echo "$MESSAGE" | jq -Rs .)
          PAYLOAD="{\"content\": ${ESCAPED_MESSAGE}}"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"
